import{a as fe}from"./chunk-ECXCPAF6.js";import{j as de,k as pe}from"./chunk-53OM6ECF.js";import{c as O}from"./chunk-3GYLW4KZ.js";var F=O(E=>{"use strict";Object.defineProperty(E,"__esModule",{value:!0});E.decodePayload=void 0;function me(r){let e=r.split(".")[1],t=atob(e);return JSON.parse(t)}E.decodePayload=me});var V=O(g=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});g.RewardTokenMinMap=g.RewardTokenMaxMap=g.transformKeys=g.inflateRewardsToken=g.minifyRewardsToken=void 0;function ve(r){return C(r,g.RewardTokenMinMap)}g.minifyRewardsToken=ve;function ge(r){return C(r,g.RewardTokenMaxMap)}g.inflateRewardsToken=ge;function C(r,e){if(typeof r!="object"||r===null)return r;if(Array.isArray(r))return r.map(n=>C(n,e));let t={};for(let n in r)if(Object.prototype.hasOwnProperty.call(r,n)){let o=e.get(n)||n;t[o]=C(r[n],e)}return t}g.transformKeys=C;var ee={v:"version",i:"id",u:"userId",d:"domain",e:"expiration",w:"publisher",t:"type",a:"amount",b:"amountCurrency",p:"maxPayoutAmount",q:"maxPayoutAmountCurrency",c:"categories",k:"cookie",l:"tiers",n:"name",r:"reward",x:"value",s:"spendCents"};g.RewardTokenMaxMap=new Map(Object.entries(ee));g.RewardTokenMinMap=new Map(Object.entries(ee).map(r=>r.reverse()))});var re=O(k=>{"use strict";Object.defineProperty(k,"__esModule",{value:!0});k.parseTokenizedReward=k.decodeAndInflate=void 0;var ye=F(),he=V();function te(r){let e=(0,ye.decodePayload)(r);return(0,he.inflateRewardsToken)(e)}k.decodeAndInflate=te;function we(r){if(!r?.token)return;let e=te(r.token);switch(e.type){case"cut":{let t=_e(e);t&&(e.type=t.type,e.amount=t.amount);break}case"forced-percentage":{e.type="percentage";break}case"threshold":{e.threshold=be(e);break}}return Object.assign(Object.assign({},r.clientData),{reward:e,token:r.token})}k.parseTokenizedReward=we;function _e(r){var e;return(e=r.categories)===null||e===void 0?void 0:e[0]}function be(r){var e;return(e=r.tiers)===null||e===void 0?void 0:e[0].spendCents}});var ne=O(P=>{"use strict";var Oe=P&&P.__createBinding||(Object.create?function(r,e,t,n){n===void 0&&(n=t);var o=Object.getOwnPropertyDescriptor(e,t);(!o||("get"in o?!e.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,n,o)}:function(r,e,t,n){n===void 0&&(n=t),r[n]=e[t]}),L=P&&P.__exportStar||function(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&Oe(e,r,t)};Object.defineProperty(P,"__esModule",{value:!0});L(F(),P);L(V(),P);L(re(),P)});var z=O(q=>{"use strict";var U=q&&q.__awaiter||function(r,e,t,n){function o(a){return a instanceof t?a:new t(function(u){u(a)})}return new(t||(t=Promise))(function(a,u){function i(s){try{d(n.next(s))}catch(l){u(l)}}function f(s){try{d(n.throw(s))}catch(l){u(l)}}function d(s){s.done?a(s.value):o(s.value).then(i,f)}d((n=n.apply(r,e||[])).next())})};Object.defineProperty(q,"__esModule",{value:!0});var Re=new Set(["and","or","not","regex","listContains","equals","elementExists"]),Pe=new Set(["url","protocol","domain","path","search","cookie","userCountry","domContent"]),K=class{constructor({url:e,protocol:t,domain:n,pathname:o,search:a,country:u,getCookie:i}){Object.assign(this,{url:e,protocol:t,domain:n,pathname:o,search:a,country:u,getCookie:i}),this.testElementExistAttemptCount=0,this.elementExistsTimeoutMs=2e3}getContextValueForOperation(e){return U(this,void 0,void 0,function*(){let{context:t}=e;if(!Pe.has(t))throw new Error(`Unsupported context [${t}]`);if(t==="url")return this.url;if(t==="protocol")return this.protocol;if(t==="domain")return this.domain;if(t==="path")return this.pathname;if(t==="search")return this.search;if(t==="cookie")return this.getCookie(e.name);if(t==="userCountry")return this.country})}test(e,t=!1){return U(this,void 0,void 0,function*(){if(!Re.has(e.operator))return console.error(`[programs] Unsupported operator [${e.operator}]`),!1;if(e.operator==="and"){if(!Array.isArray(e.value))throw new Error("The value of operator `and` must be an array");let n=!0;for(let o of e.value)if(!(yield this.test(o,t))){n=!1;break}return n}if(e.operator==="not"){if(Array.isArray(e.value))throw new Error("The value of operator `not` must be a single condition");return(yield this.test(e.value,t))===!1}if(e.operator==="or"){if(!Array.isArray(e.value))throw new Error("The value of operator `or` must be an array");let n=!1;for(let o of e.value)if(yield this.test(o,t)){n=!0;break}return n}if(e.operator==="regex"){let n=yield this.getContextValueForOperation(e);if(typeof n!="string")return!1;let o=e.value||e.pattern;return o&&!!n.match(new RegExp(o,e.flags||""))}if(e.operator==="listContains"){let n=yield this.getContextValueForOperation(e);return Array.isArray(e.value)&&e.value.includes(n)}if(e.operator==="equals"){let n=yield this.getContextValueForOperation(e);return e.value===n}if(e.operator==="elementExists"){if(!t)return!1;try{return yield this.testElementExists(e.value)}catch(n){return console.error("[programs] program rules error",n),null}}return!1})}hasDomContentRule(e){let t=!1,n=o=>{if(Array.isArray(o.value))for(let a of o.value)n(a);o.context==="domContent"&&(t=!0)};return n(e),t}testClientRules(e,t){return U(this,void 0,void 0,function*(){return t&&(this.elementExistsTimeoutMs=t),{matched:yield this.test(e,!0),elementExistTestCount:this.testElementExistAttemptCount}})}testElementExists(e){return U(this,void 0,void 0,function*(){let n=this.elementExistsTimeoutMs/100;return new Promise((o,a)=>{if(document.querySelectorAll(e).length>0)return o(!0);try{let i=0,f=setInterval(()=>{i++;let d=document.querySelectorAll(e);if(this.testElementExistAttemptCount++,d.length>0)return clearInterval(f),o(!0);if(i>=n)return clearInterval(f),o(!1)},100)}catch(i){return a(i)}})})}};q.default=K});var oe=O(Q=>{"use strict";Object.defineProperty(Q,"__esModule",{value:!0});function Te(r=[]){let e=r.find(t=>t.indexOf("c_ranker_")===0);if(e)return e.split("c_ranker_")[1]}Q.default=Te});var J=O(H=>{"use strict";Object.defineProperty(H,"__esModule",{value:!0});var W=pe(),je=["1password.com","pantheonsite.io"];function Ae(r){let e=W.getDomain(r);if(!e){let a=W.getPublicSuffix(r);if(je.includes(a))return a}let t=W.getSubdomain(r),n=t&&t.startsWith("www.")?t.substr(4):t,o=`${n}.${e}`;return n&&n!=="www"?o:e}H.default=Ae});var G=O(S=>{"use strict";Object.defineProperty(S,"__esModule",{value:!0});S.BonusOfferType=void 0;var ie;(function(r){r.newUserActivationBonus="nuab",r.firstTimeEmailActivationBonus="fteab",r.firstTimeEmailActivationBonusMobile="fteabm",r.desktopToMobileAppBonus="dtmab"})(ie||(S.BonusOfferType=ie={}))});var le=O(w=>{"use strict";var M=w&&w.__awaiter||function(r,e,t,n){function o(a){return a instanceof t?a:new t(function(u){u(a)})}return new(t||(t=Promise))(function(a,u){function i(s){try{d(n.next(s))}catch(l){u(l)}}function f(s){try{d(n.throw(s))}catch(l){u(l)}}function d(s){s.done?a(s.value):o(s.value).then(i,f)}d((n=n.apply(r,e||[])).next())})};Object.defineProperty(w,"__esModule",{value:!0});w.getProgramDataById=w.applyClientRules=w.fetchReward=void 0;var xe=de(),$=fe(),ke=ne(),Y=z(),Me=oe(),ae=J(),X=G(),se=globalThis.URL?globalThis.URL:xe.URL;function Z({fetchOptions:r,ignoreCache:e,omitCredentials:t,session:n}){let o=n?.sessionToken?{"x-wb-session":decodeURIComponent(n.sessionToken)}:void 0,a=e?{"cache-control":"no-cache"}:void 0,u=Object.assign(Object.assign({},o),a);return Object.assign(Object.assign({headers:u},{credentials:t?"omit":void 0}),r)}function Ce(r,{apiBase:e,session:t,ignoreCache:n,experience:o,omitCredentials:a,onFetchError:u,fetchOptions:i}){var f;return M(this,void 0,void 0,function*(){let d=Z({fetchOptions:i,ignoreCache:n,omitCredentials:a,session:t}),l=yield(yield(0,$.memoizedFetch)(`${e}/v1/programs/${r}${o?`?experience=${o}`:""}`,d,u)).json();return(f=l?.programs)===null||f===void 0?void 0:f.rules})}function ue(r,{apiBase:e,extensionName:t,ignoreCache:n,omitCredentials:o,onFetchError:a,fetchOptions:u,session:i,subExperience:f,url:d}){var s;return M(this,void 0,void 0,function*(){let l=Z({fetchOptions:u,ignoreCache:n,omitCredentials:o,session:i}),R=(0,Me.default)(i?.features),j=`?${t?`extension=${t}`:""}${R?`&ranker=${R}`:""}`,v=(s=i?.features)===null||s===void 0?void 0:s.includes("rewards_engine_enabled"),_=(0,$.memoizedFetch)(`${e}/v1/program/${r}/coupons${j}`,l,a).then(x=>x.json()),T=ce(r,{apiBase:e,fetchOptions:u,ignoreCache:n,omitCredentials:o,onFetchError:a,session:i,subExperience:f,url:d}),p=(0,$.memoizedFetch)(`${e}/v1/program/${r}`,l,a).then(x=>x.json()),[y,c,b]=yield Promise.all([_,T,p]);b.meta=qe(b?.meta,y?.meta);let A=v&&(0,ke.parseTokenizedReward)(c?.rewards)||c?.rewards,h=Object.assign(Object.assign({},b.siteData),{coupons:y?.coupons,cashback:A});return v&&c?.redirectUrl&&(h.cashback=Object.assign(Object.assign({},h.cashback),{redirectUrl:c.redirectUrl})),v&&c?.homepageRedirectUrl&&(h.cashback=Object.assign(Object.assign({},h.cashback),{homepageRedirectUrl:c.homepageRedirectUrl})),c?.cs&&(h.cashback=Object.assign(Object.assign({},h.cashback),{cs:c.cs})),Object.assign(Object.assign({},b),{siteData:h})})}function ce(r,{apiBase:e,bonusOfferType:t,fetchOptions:n,ignoreCache:o,omitCredentials:a,onFetchError:u,session:i,subExperience:f,url:d}){var s,l,R;return M(this,void 0,void 0,function*(){let j=(s=i?.features)===null||s===void 0?void 0:s.includes("rewards_engine_enabled"),v="";if(j){let p=new URLSearchParams;p.append("re","t"),t&&(p.append("b","t"),t===X.BonusOfferType.newUserActivationBonus?p.append("sxp","ext"):t===X.BonusOfferType.desktopToMobileAppBonus?p.append("sxp","mobile"):t===X.BonusOfferType.firstTimeEmailActivationBonusMobile&&p.append("sxp","mobile_email")),d&&(!((l=i?.features)===null||l===void 0)&&l.includes("use_redirect_link_service"))&&(!((R=i?.features)===null||R===void 0)&&R.includes("use_redirect_v_3"))&&p.append("destUrl",d),f&&p.append("sxp",f),v=`?${p}`}let _=Z({fetchOptions:n,ignoreCache:o,omitCredentials:a,session:i});return(0,$.memoizedFetch)(`${e}/v1/program/${r}/rewards${v}`,_,u).then(p=>p.json())})}w.fetchReward=ce;function qe(r={},e={}){return Object.assign(Object.assign({},r),e)}function De({url:r,session:e,getCookie:t,apiBase:n,extensionName:o,ignoreCache:a,experience:u,subExperience:i,platformDomain:f,omitCredentials:d,onFetchError:s,fetchOptions:l}){return M(this,void 0,void 0,function*(){let R=f||(0,ae.default)(r),{pathname:j,hostname:v,protocol:_,search:T}=new se(r),p=e.country;n=n||"https://capitaloneshopping.com/api";let y=yield Ce(R,{apiBase:n,ignoreCache:a,session:e,extensionName:o,experience:u,omitCredentials:d,onFetchError:s,fetchOptions:l}),c=y.filter(I=>{let{rulesTree:B}=I;return!new Y.default({url:r,domain:v,pathname:j,protocol:_,search:T,country:p,getCookie:t}).hasDomContentRule(B)}),b=c.length<y.length,A;for(let I of c){let{programId:B,rulesTree:N}=I;if(yield new Y.default({url:r,domain:v,pathname:j,protocol:_,search:T,country:p,getCookie:t}).test(N)){A=B;break}}if(!A&&!y.length)return;let h;return A&&(h=yield ue(A,{apiBase:n,ignoreCache:a,session:e,extensionName:o,url:r,omitCredentials:d,fetchOptions:l,subExperience:i})),{program:h,deferredProgramSelection:b?y:null}})}w.default=De;function Ee(r,e,t,n,o){return M(this,void 0,void 0,function*(){let a=(0,ae.default)(e),{pathname:u,protocol:i,search:f}=new se(e),d=(v,_)=>(v+=_.duration,v),s=[],l=0;for(let v of r){l++;let _=performance.now(),{programId:T,rulesTree:p}=v,y=new Y.default({url:e,protocol:i,domain:a,pathname:u,search:f,country:t,getCookie:n}),{matched:c,elementExistTestCount:b}=yield y.testClientRules(p,o?.programAttemptTimeoutMs),h=performance.now()-_;if(s.push({program:T,duration:h,attempts:b}),c){let x=s.reduce(d,0);return{programId:T,metrics:{totalDuration:x,programsTestedCount:l,attempts:s}}}}return{metrics:{totalDuration:s.reduce(d,0),programsTestedCount:l,attempts:s}}})}w.applyClientRules=Ee;function Ue(r,{url:e,session:t,apiBase:n,extensionName:o,ignoreCache:a,omitCredentials:u,fetchOptions:i,subExperience:f}){return M(this,void 0,void 0,function*(){return n=n||"https://capitaloneshopping.com/api",yield ue(r,{apiBase:n,ignoreCache:a,session:t,extensionName:o,url:e,omitCredentials:u,fetchOptions:i,subExperience:f})})}w.getProgramDataById=Ue});var Be=O(m=>{"use strict";Object.defineProperty(m,"__esModule",{value:!0});m.ProgramRules=m.getSiteDomainFromUrl=m.getProgramDataById=m.getProgram=m.fetchReward=m.applyClientRules=m.BonusOfferType=void 0;var D=le();m.getProgram=D.default;Object.defineProperty(m,"applyClientRules",{enumerable:!0,get:function(){return D.applyClientRules}});Object.defineProperty(m,"fetchReward",{enumerable:!0,get:function(){return D.fetchReward}});Object.defineProperty(m,"getProgramDataById",{enumerable:!0,get:function(){return D.getProgramDataById}});var Se=z();m.ProgramRules=Se.default;var $e=J();m.getSiteDomainFromUrl=$e.default;var Ie=G();Object.defineProperty(m,"BonusOfferType",{enumerable:!0,get:function(){return Ie.BonusOfferType}});m.default=D.default});export{ne as a,Be as b};
