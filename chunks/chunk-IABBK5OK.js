import{a as ue,c as oe}from"./chunk-AHW6BBB4.js";import{a as ee}from"./chunk-XXVKPEZT.js";import{K as X,O as j,c as Q,d as V,i as D,o as F,w as J,x as Y}from"./chunk-B7TRBNR3.js";import{a as b}from"./chunk-QCPV2SDO.js";import{a as Z}from"./chunk-MYY6QNB4.js";import{b as z}from"./chunk-XEYZDI33.js";import{b as T}from"./chunk-QLZPWOED.js";import{c as W}from"./chunk-OCTA2RVM.js";import{d as q,j as K,q as H}from"./chunk-4MWWZMVF.js";import{a as G,h as p,n as g,o as _,v as A}from"./chunk-2WJMAHXV.js";import{a as ce}from"./chunk-WRIUWJSJ.js";import{G as C,z as le}from"./chunk-4MSTBY6L.js";import{e as m}from"./chunk-3GYLW4KZ.js";var t=m(z());var h=async(e,o)=>{if(!(g("ext_ignore_abe_throttle")&&(e==="throttleBonusOffer"||e==="throttleBonusOfferGlobal")))return await A("bonusOfferThrottle",{methodName:e,domain:o})};var te=async({programId:e,url:o,bonusOfferType:i})=>await A("fetchReward",{programId:e,url:o,bonusOfferType:i});var pe=/(^|\.)amazon\.com$/i,de=13;function r(...e){g("ext_abe_debug")&&console.log("[ABE]",...e)}function me(){return location.href.startsWith("https://www.amazon.com")&&/^https:\/\/www\.amazon\.com(?!.*refinements=p_n_hba_program)/.test(location.href)}function L(e,o,i){let l=g(e),s=!i||i.includes(o);return l?s||r(`skipping '${o}' bonus reward fetch since it is not in 'allowOnly' array: [${i}]`):r(`skipping '${o}' bonus reward fetch since feature '${e}' is not enabled`),l&&s?te({programId:p.get("siteAPIData","programId"),url:location.href,bonusOfferType:o}):Promise.resolve(null)}async function re(e,o,{allowOnly:i}={}){if(r(i?`requesting [${i}] bonus reward(s)`:"requesting any bonus reward"),!o.includes(e?.pageType)){r(`skipping since current pageType (${e?.pageType}) is not specified in 'pageTypes' array: [${o}]`);return}if(Q()||V()){r("skipping due to stand down");return}if(!await h("canShowBonusOffer",e?.domain)){r("skipping since bonus reward notification is throttled");return}let x=g("ext_to_eml_re_abe_checkout")?"ext_to_eml_re_abe_checkout":"ext_to_eml_abe_checkout",O=g("ext_to_eml_re_abe_product")?"ext_to_eml_re_abe_product":"ext_to_eml_abe_product",U=e?.pageType==="cartPage"||e?.pageType==="checkoutPage"?x:O,R=e?.pageType==="cartPage"||e?.pageType==="checkoutPage"?"ext_to_ma_abe_checkout":"ext_to_ma_abe_product",v=p.get("smpUniqueCount")>=de,M=G(),w=pe.test(M),P=w?"ext_nu_abe_amz":"ext_nu_abe_non_amz",I=!w||me(),[k,B,u]=await Promise.all([(b()||v)&&I?L(P,t.BonusOfferType.newUserActivationBonus,i):null,w?null:L(U,t.BonusOfferType.firstTimeEmailActivationBonus,i),b()&&!w?L(R,t.BonusOfferType.desktopToMobileAppBonus,i):null]);k!==null?r(`fetched '${t.BonusOfferType.newUserActivationBonus}' bonus reward:`,k):!b()&&!v&&r(`skipped '${t.BonusOfferType.newUserActivationBonus}' bonus reward fetch since shadow user does not have required SMP count`),B!==null?r(`fetched '${t.BonusOfferType.firstTimeEmailActivationBonus}' bonus reward:`,B):w&&r(`skipped '${t.BonusOfferType.firstTimeEmailActivationBonus}' bonus reward fetch since user is on Amazon domain`),u!==null?r(`fetched '${t.BonusOfferType.desktopToMobileAppBonus}' bonus reward:`,u):(b()||r(`skipped '${t.BonusOfferType.desktopToMobileAppBonus}' bonus reward fetch since user is not signed in`),w&&r(`skipped '${t.BonusOfferType.desktopToMobileAppBonus}' bonus reward fetch since user is on Amazon domain`));let f=!!k?.reward?.amount,d=!!B?.reward?.amount,a=!!u?.reward?.amount;if(d){let $=await chrome.runtime.sendMessage({type:"embeddedSignUpCookieIsIncognito"}).catch(()=>null);$?$.incognito&&(r(`ignoring '${t.BonusOfferType.firstTimeEmailActivationBonus}' bonus reward as incognito mode`),d=!1):(r(`ignoring '${t.BonusOfferType.firstTimeEmailActivationBonus}' bonus reward since incognito check failed`),_("track","error",{name:"bonus_reward_notification_incognito_check_fail"}),d=!1)}d&&a&&(a=g("prioritize_desktop_to_app_bonus"),d=!a,a&&r(`prioritizing '${t.BonusOfferType.desktopToMobileAppBonus}' over '${t.BonusOfferType.firstTimeEmailActivationBonus}' test`)),f&&(d||a)&&(r(`skipping '${t.BonusOfferType.newUserActivationBonus}' bonus reward due to '${d?t.BonusOfferType.firstTimeEmailActivationBonus:t.BonusOfferType.desktopToMobileAppBonus}' test`),f=!1);let c;return d?c={type:t.BonusOfferType.firstTimeEmailActivationBonus,reward:B}:a?c={type:t.BonusOfferType.desktopToMobileAppBonus,reward:u}:f&&(c={type:t.BonusOfferType.newUserActivationBonus,reward:k}),c&&r(`showing '${c.type}' bonus reward notification:`,c.reward),c}var S=m(z());async function N(e,o){return A("bonusOfferApiUtils",{methodName:e,args:o})}var y=m(le()),ie=m(ce()),ne=m(ue());var n=m(C()),we=`${q}/lp/signup/embed/extension`;function ge({bonusReward:e,closeModal:o,onStepChange:i}){let[l,s]=(0,y.useState)(!0),E=(0,ne.useSpinDelay)(l);return(0,n.jsx)("div",{className:"fixed top-0 left-0 w-full h-full flex justify-center items-center bg-black bg-opacity-50",children:(0,n.jsxs)("div",{className:"relative w-[600px] h-[600px] bg-white",children:[(0,n.jsx)("button",{onClick:o,"aria-label":"Close",className:"absolute top-2 right-2 p-2",children:(0,n.jsx)(W,{className:"h-4 w-4"})}),E&&(0,n.jsx)("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2",children:(0,n.jsx)(Z,{className:"w-6 h-6"})}),(0,n.jsx)(oe,{closeModal:o,iframeLandingPagePath:"/lp/signup/embed/extension",onStepChange:i,onLoadComplete:()=>s(!1),onSignUpComplete:()=>{e.token&&N("sendBonusOfferEmail",[e.token])}})]})})}function ae({blocksSlug:e,bonusReward:o,capitalizePrefix:i,lexiScope:l,notificationName:s,qrCodeToken:E}){let[x,O]=(0,y.useState)(!1),[U,R]=(0,y.useState)(!1),v=(0,y.useRef)("unknown"),{getFullDescription:M,getText:w,getSuffix:P}=X({country:p.get("session","country"),currency:o.reward?.amountCurrency,truncateIntegers:!0}),I=J(`${K}?${ie.default.stringify({domain:o.reward?.domain})}`);function k(f){v.current=f}function B(){O(!1),chrome.runtime.sendMessage({type:"embeddedSignUpCookieRevertSameSiteProperty"}),_("track","closeModal",{label:v.current})}if(x)return(0,n.jsx)(ge,{bonusReward:o,onStepChange:k,closeModal:B});if(I===""||U)return null;let u=p.get("cashback","reward");return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(ee,{blocksSlug:e,templateData:{vendor:p.get("cashback","vendor"),bonusRewardText:M(o.reward,{capitalizePrefix:i}),standardRewardText:u?w(u)+P(u):void 0,logoImageUri:I||Y,lexiScope:l,notificationName:s,qrCodeToken:E},onEvent:f=>{if(![T.NotificationShow,T.NotificationDismiss,T.Custom].includes(f.type))return;let a=f.data?.propsData?.name,c=typeof f.data?.label=="string"?f.data.label.trim():"";switch(f.type){case T.NotificationShow:{_("page",a,{pageType:p.get("deweyResult","pageType"),meta:JSON.stringify({bonusRewardId:o.reward.id,standardRewardId:u?.id})}),h("throttleBonusOffer",p.get("siteAPIData","tld"));break}case T.NotificationDismiss:{D(a,"x","dismiss","primary"),h("throttleBonusOfferGlobal");break}}switch(f.eventName){case"activatePrimaryCta":{D(a,c,"cta","primary"),s==="bonusNotifNewUser"?F({reward:o.reward,token:o.token,view:a,label:c.toLowerCase(),sendClickEvent:!1}):s==="bonusNotifEmailOnly"&&(b()&&o.token&&N("sendBonusOfferEmail",[o.token]),O(!0),j({programId:p.get(["siteAPIData","programId"]),creditsDeferred:!1})),R(!0),h("throttleBonusOfferGlobal");break}case"activateSecondaryCta":{D(a,c,"cta","secondary",s==="bonusNotifEmailOnly"?{redirect:!0,cashback:!0}:{}),s==="bonusNotifEmailOnly"&&F({reward:u,view:a,label:c.toLowerCase(),sendClickEvent:!1}),R(!0),h("throttleBonusOfferGlobal");break}}}}),(0,n.jsx)("link",{rel:"prefetch",href:we})]})}var fe=m(C());async function se(e){let o;if(e.type===S.BonusOfferType.desktopToMobileAppBonus&&e?.reward?.token&&(o=await N("createDtmaQrCodeToken",[e.reward.token]),!o)){_("trackError","createDtmaQrCodeTokenFailed","loadBonusRewardNotification");return}let l={[S.BonusOfferType.newUserActivationBonus]:{blocksSlug:"bonus-reward-notification-generic",bonusReward:e.reward,capitalizePrefix:!0,lexiScope:"Bonus_Reward_Notification_New_User",notificationName:"bonusNotifNewUser"},[S.BonusOfferType.firstTimeEmailActivationBonus]:{blocksSlug:"bonus-reward-notification-generic",bonusReward:e.reward,capitalizePrefix:!0,lexiScope:"Bonus_Reward_Notification",notificationName:"bonusNotifEmailOnly"},[S.BonusOfferType.desktopToMobileAppBonus]:{blocksSlug:"bonus-reward-notification-dtma",bonusReward:e.reward,capitalizePrefix:!1,qrCodeToken:o}}[e.type];return l?await H({appName:"blocksNotification",blankSlate:!0,app:(0,fe.jsx)(ae,{...l})}):void 0}export{me as a,re as b,se as c};
