import{a as G,d as ve,e as ke,f as Ie}from"./chunk-AWICE72Y.js";import{e as he,f as we,g as _e,h as Se,j as Ce,z as Te}from"./chunk-KWPMO2TR.js";import{a as Ae,b as Ne,c as Ve}from"./chunk-KEC65WDD.js";import{a as H,b as F,c as Pe}from"./chunk-IABBK5OK.js";import{a as be}from"./chunk-IJOGWUSA.js";import{a as b,b as E}from"./chunk-EFZNXUV7.js";import{a as ye}from"./chunk-NCANGEQT.js";import{I as fe,L as ue,N as q,a as M,e as ce,f as pe,g as le,k as me}from"./chunk-B7TRBNR3.js";import{c as ge}from"./chunk-TY2WWATK.js";import{b as de}from"./chunk-77Z4FAWZ.js";import{a as Re}from"./chunk-LTOPIHVT.js";import{a as De}from"./chunk-IUMQMMIE.js";import{a as J}from"./chunk-M25S27FE.js";import{b as Ge}from"./chunk-XEYZDI33.js";import{a as ee,b as He}from"./chunk-J7QHBV67.js";import{a as re}from"./chunk-NYCEM6H3.js";import{a as ne}from"./chunk-2JQDE4PE.js";import{b as se}from"./chunk-DKGSS5NA.js";import{q as W}from"./chunk-4MWWZMVF.js";import{a as N,b as B,g as f,h as t,n as w,o as _,r as ie,v as ae}from"./chunk-2WJMAHXV.js";import{g as Y,n as Z,s as qe}from"./chunk-QWQLNDJC.js";import{b as te,c as $e}from"./chunk-WRIUWJSJ.js";import{G as oe}from"./chunk-4MSTBY6L.js";import{b as We,e as Je}from"./chunk-C4QCPH6A.js";import{c as y,e as I,f as Me}from"./chunk-ZRHTGYWI.js";import{e as A}from"./chunk-3GYLW4KZ.js";var Ue=A(We());qe();var o=A(Je());var v=A(Ge());Me();He();$e();var xe=()=>ae("hasDeferredCouponRewards");var Q=A(oe());window.__wb_timing.couponsRequireAt=performance.now();var je=new Set(["etsy.com","amazon.com"]),P=!1,V=!1,$,j,x,C,K=!1,Ke=o.default.throttle(re,2e3),Qe=()=>{setTimeout(()=>{let e={currentLocation:o.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])},r=o.default.extend({},window.__wb_timing,e);_("track","pageTimingMetrics",r)},5e3)};function Xe(){return $||($=Ue.default.all([De(),J(),me(),ye(),xe(),Ae(),be()]).spread((e,r,c,a,n,p,u)=>{Re(e),t.merge({siteAPIData:r}),t.merge({cashback:c}),t.set("lifetimeSavings",a),t.set(["couponView","hasDeferredCouponRewards"],n),t.set(["couponView","elasticityUserDomain"],p),t.set("domainLists",u),B(r?.tld)})),$}var Ye=[{domain:"etsy.com"},{domain:"amazon.com",condition:e=>{let r=o.default.get(e,"pageType")==="checkoutPage",c=o.default.get(e,"pageData.meta"),a=c?c.coupon_input_present:!1;return r&&a}}];function Oe(e,r){return!!o.default.find(Ye,a=>a.domain===e&&(a.condition?a.condition(r):!0))}async function Ze(){I("COUPONS INIT");let[e,r,c,a]=await Promise.all([b("emailCreateAccount"),b("affiliateRedirect"),b("couponRun"),b("tripId"),Xe()]);I("COUPONS DATA LOADED");let n=N();if(Qe(),navigator.userAgent.indexOf("Firefox")>-1&&n.match(/eyebuydirect\.com/))return!1;let p=t.get("cashback");if(e&&JSON.parse(e)?.shouldLoadNotification&&(await E("emailCreateAccount"),ge(o.default.get(p,"reward",null))),r){let s=JSON.parse(r);t.set("affiliateRedirect",s);let{fromAutoRun:i,hasCredits:S}=s||{};a&&w("ext_deferred_coupon_rewards_v_2")&&t.get("cashback","redirectUrl")&&i&&S===!1&&ve(a)}else c||(sessionStorage.removeItem("__s_sitehub_try_codes"),a&&E("tripId"));a&&t.set(["couponView","tripId"],a),t.set("couponsVisible",!1);let u=t.get("siteAPIData");await at(u);let m=await nt(u),l;try{l=JSON.parse(sessionStorage.getItem("ogPageData")),l&&l.expires<ee()&&(sessionStorage.removeItem("ogPageData"),l=null)}catch{}async function k(s){if(I("onDeweyResult",s),Ke(n,s),await it(s),s.callSource==="internal"&&s.pageData)try{let i=JSON.parse(sessionStorage.getItem("cartTotalAfterSavings"));if(sessionStorage.removeItem("cartTotalAfterSavings"),!Number.isNaN(i.value)){let S=Date.now()-i.time;s.pageData?.order?.total>i.value&&S<2e3&&_("track","extensionError",{type:"coupon_error"})}}catch{}if(s.callSource==="coupons_start"&&s.pageData)sessionStorage.setItem("ogPageData",JSON.stringify({...s.pageData,expires:Z(Y(new Date,3))}));else if(s.callSource==="coupons_end"){let i=t.select("couponView").get("resultTemp");i||(i=t.select("couponView").get("result"),i.pageReload=void 0);try{l=JSON.parse(sessionStorage.getItem("ogPageData"))}catch{}sessionStorage.removeItem("ogPageData");let S=o.default.get(l,"order.total");if(i.deweyOriginalTotal=S,i.savings>0){o.default.get(s,"pageData.products.length")>1?s.pageData.products=o.default.map(s.pageData.products,(h,z)=>(o.default.has(h,"list_price")&&o.default.has(l,`products[${z}].list_price`)&&l.products[z].list_price-h.list_price&&(h.coupon_savings=l.products[z].list_price-h.list_price),h.coupon_applied=i.bestCoupon.code,h)):o.default.get(s,"pageData.products.length")===1&&(s.pageData.products[0].coupon_savings=i.savings,s.pageData.products[0].coupon_applied=i.bestCoupon.code);let R=s.pageData?.order?.total;R>0&&sessionStorage.setItem("cartTotalAfterSavings",JSON.stringify({value:R,time:Date.now()}))}let U=N(),g=t.get("couponsConfig");if(g&&g.pageWasReloaded){g.result=i;let R=t.get("couponView"),h=o.default.get(R,"resultTemp.allCoupons",[]);je.has(U)&&h.length>0&&(g.coupons=o.default.cloneDeep(h)),y("ext_coupons_immediate_logs","coupons prepare pageWasReloaded"),D(g,p)}else t.select("couponView").set("result",i);i&&i.couponScriptType==="roo"&&_("track","rooActionTiming",{triggerType:M({automaticCouponsRun:i.automaticCouponsRun,autoFallback:i.autoFallback,isSiteHub:i.isSiteHub,isCouponsImmediate:i.isCouponsImmediate}),couponRunId:i.couponRunId,aggApplyCodeTime:i.aggApplyCodeTime,aggGetTotalTime:i.aggGetTotalTime,aggRemovePreviousTime:i.aggRemovePreviousTime,aggWaitForReloadTime:i.aggWaitForReloadTime,initialActionTime:i.initialActionTime,currentLocation:o.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])});let{automaticCouponsRun:Ee,autoFallback:Fe,isSiteHub:ze}=i,Be=M({automaticCouponsRun:Ee,autoFallback:Fe,isSiteHub:ze,isCouponsImmediate:we()});rt({couponResult:i,triggerType:Be,siteAPIData:u}),_("track","deweyResult",o.default.assign(s,{url:window.location.href}))}else if(l&&o.default.get(s,"pageType")&&!V)V=!0,m();else if(Oe(n,s)&&!P){if(o.default.get(s,"pageData"))if(n==="amazon.com")await Le(s,m,p);else{let i=await m();if(i){P=!0;let S=await f({message:"getClassifierCodes",domain:n,pageData:s.pageData});if(S){let U=o.default.get(u,"siteData.coupons.count"),g=o.default.concat(S,i.coupons);g=o.default.uniqBy(g,"code"),g=g.slice(0,U),i.coupons=g}D(i,p)}}}else if(V&&w("ext_coupons_skip_cashback_fallback")&&u?.siteData?.coupons?.type==="roo"&&(s.pageType==="cartPage"||s.pageType==="checkoutPage")&&!t.get(["couponView","rooIsCheckingForCouponPage"])&&!t.get(["couponView","rooIsCouponPage"])){let i=await m();i&&D(i,p)}else if(!w("ext_coupons_skip_cashback_fallback")&&!t.get("cashbackVisible")&&!o.default.get(p,"postCoupons")&&(setTimeout(()=>{if(!t.get("couponsVisible")&&!K){let i=t.get("deweyResult");q(i)}},1e3),!C&&!x&&H()&&(x=F(t.get("deweyResult"),["productPage"],{allowOnly:[v.BonusOfferType.newUserActivationBonus]}),C=await x,C))){let i={};y("ext_coupons_immediate_logs","coupons prepare onDeweyResult"),D(i,p)}}let O=await b("rooReloading"),d=t.get("deweyResult");d&&!O&&k(d),O&&await E("rooReloading"),de.emitter.on("result",async s=>{let i=await Ne();Ve(i),k(s)}),await ie(),d=t.get("deweyResult");let L=Oe(n,d),T;!L&&!V&&(V=!0,T=await m());let X=o.default.get(d,"pageData");if(L){if(n==="amazon.com")await Le(d,m,p);else if(X&&!P){let s=await m();if(s){P=!0;let i=await f({message:"getClassifierCodes",domain:n,pageData:X});i&&(s.coupons=i),D(s,p)}}}T&&!T.pageWasReloaded&&(y("ext_coupons_immediate_logs","coupons prepare default"),D(T,p))}async function D(e,r){I("PREPARE COUPONS",{coupons:e,cashback:r});let{standDown:c}=e,a=N();if(t.merge("couponView",e),_e()){if(e.isImmediateNotif)j=performance.now(),y("ext_coupons_immediate_logs","couponsImmediate loaded"),t.set(["couponView","hasInitialized"],!1);else if(j){y("ext_coupons_immediate_logs","coupons has initialized");let T=((performance.now()-j)/1e3).toFixed(1);y("ext_coupons_immediate_logs",`couponsImmediate loaded %c${T}s%c faster than coupons`,"color: lime;","color: inherit;"),t.set(["couponView","hasInitialized"],!0)}}let n=t.get("cashbackView")||r;t.set("cashbackView",n);let p={cssUrl:"coupons.css"};if(n&&o.default.get(n,"user.compInactivated")&&ue()&&!t.get("cashbackReactivateVisible")&&!t.get("throttleCreditsReactivation")){t.set(["warnAboutStandDown"],!0),t.set("cashbackReactivateVisible",!0),W({...p,appName:"reactivate",app:(0,Q.jsx)(fe,{})});return}(sessionStorage.getItem("__wb_same_tab_auto")||sessionStorage.getItem("__r_reload_auto"))&&await f({domain:a,message:"endThrottle"});let m=Ce(),l=a;ne(a)&&t.get("deweyResult","pageType")==="checkoutPage"&&(l="amazon.com_checkout");let k=await f({domain:l,message:"isThrottled",isAutoCoup:m});if(m&&await f({domain:l,message:"isAutoCoupThrottled",isAutoCoup:m})){if(t.get("affiliateRedirect")&&!localStorage.getItem("__wb_redirecting")){k||Se();return}t.select("couponView").set("autoCoupThrottled",!0)}let O=!!t.get(["events","hasSeenCouponsThrottleToolTip"]),d=k&&!O&&!e.pageWasReloaded;if(t.select("couponView").set("showThrottleToolTip",d),k&&!e.pageWasReloaded&&(t.set("couponsThrottled",!0),!d)){w("ext_coupons_skip_cashback_fallback")&&!w("ext_coupons_skip_cashback_when_throttled")&&q(t.get("deweyResult"));return}if(c){t.set("couponsThrottled",!0),pe();return}else if(ce()){le();return}if(a==="groupon.com"&&_("track","foundCouponsEnd",{pageViewId:t.get("pageViewId")}),!t.get("couponsVisible")){if(!e?.pageWasReloaded){if(K)return;if(!C&&(w("ext_to_eml_re_abe_checkout")||w("ext_to_eml_abe_checkout")||w("ext_to_ma_abe_checkout"))&&(C=await F(t.get("deweyResult"),["cartPage","checkoutPage"],{allowOnly:[v.BonusOfferType.firstTimeEmailActivationBonus,v.BonusOfferType.desktopToMobileAppBonus]})),!C&&!x&&H()&&(x=F(t.get("deweyResult"),["productPage"],{allowOnly:[v.BonusOfferType.newUserActivationBonus]})),C){Pe(C),K=!0,t.set("cashbackVisible",!1);return}}t.set("couponsVisible",!0),W({...p,appName:ke,app:(0,Q.jsx)(Ie,{})})}}function et(e){_("track","platformIdentified",{platform:e,currentLocation:o.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])})}async function tt(){if(t.get("platform")==="Shopify"){let r=window.location.hostname,c=t.get("platformSiteUrl");c&&(r=(0,v.getSiteDomainFromUrl)(c));let a=await f({message:"makeRequest",reqInfo:{method:"GET",url:`https://${r}/cart.json`,headers:{Accept:"*/*"}}});if(a?.items?.length>0)return ot(a)}}function ot(e){let r=o.default.map(e.items,c=>o.default.pick(c,["id","product_id","sku","url","discounts","discounted_price","original_price","image","title","variant_title"]));return JSON.stringify({cartLevelDiscountApplications:e?.cart_level_discount_applications,cartItems:r,originalTotal:e?.original_total_price,totalDiscount:e?.total_discount,totalPrice:e?.total_price})}async function it(e){let r=N();if(t.get("platform")==="Shopify"&&e&&e.pageType==="checkoutPage"){let a=document.querySelectorAll(".notice.notice--warning .notice__text"),n=o.default.find(a,p=>p.offsetHeight>0);if(n){let p=n.querySelector("strong").innerText.trim();_("track","shopifyInvalidCouponDetected",{domain:r,coupon:p})}}}async function at(e){let r=o.default.get(e,"tld");B(r);let[c,a,n]=await Promise.all([f({message:"getPlatform"}),f({message:"getPlatformDomain"}),f({message:"getPlatformSiteUrl"})]);c&&(t.set("platform",c),et(c),a&&t.set("platformDomain",a),n&&t.set("platformSiteUrl",n))}async function nt(e){let r=t.get("platform"),c=t.get("platformDomain"),a=t.get("platform")==="Shopify";return o.default.get(e,"siteData.coupons.ignoreSite")?o.default.noop:o.default.get(e,"siteData.coupons.type")==="eeyore"&&o.default.get(e,"siteData.coupons.coupons.length")>0?o.default.get(e,"siteData.coupons.identifiers")?Te:o.default.noop:r?(c&&a&&(e.siteData.coupons.shopify=!0,e.siteData.appliedCodeSelector=".applied-reduction-code__information",await J(o.default.assign(e,{domain:c,setSite:!0}))),G):o.default.get(e,"siteData.coupons.type")==="roo"?he.initCoupons:o.default.get(e,"siteData.coupons.type")==="asyncTigger"?o.default.get(e,"siteData.coupons.identifiers")?G:o.default.noop:o.default.noop}async function Le(e,r,c){if(e){let a=await r({experience:"checkout"});P=!0;let n=await f({message:"getClassifierCodes",domain:"amazon.com",pageData:e.pageData,pageViewId:t.get("pageViewId")});n&&(a.coupons=n),n&&n.length>=1&&(a.couponCount=n.length,D(a,c))}}function st(e){let a=!1,n=e||0;return n=parseInt(n),isNaN(n)&&(a=!0,n=0),n>1e8?(a=!0,n=1e8):n<-1e8&&(a=!0,n=-1e8),{cleanedSavings:n,wasCleaned:a}}I(document.readyState);async function rt({couponResult:e,triggerType:r,siteAPIData:c}={}){let{cleanedSavings:a,wasCleaned:n}=st(e.savings),p=new Date().getTime()-o.default.get(e,"startTime")||null,u=se(a,{noDollarSign:!0})??"0",m=o.default.round(parseFloat(u),2);await chrome.storage.local.set({lastCouponSavings:m});let l=await tt();_("track","tryCouponsResult",{triggerType:r,couponScriptType:e.couponScriptType,clickId:e.clickId,redirectId:te(e.clickId),couponRunId:e.couponRunId,cashback:e.cashback,deweyOriginalTotal:e.deweyOriginalTotal,originalTotal:e.originalTotal,originalTotalV2:e.originalTotalV2,baseTotal:e.baseTotal,finalTotal:e.finalTotal,savingsOld:e.savings||0,savings:a,savingsCurrency:c?.siteData?.merchantPage?.currency,savingsWasCleaned:n,shopifyLoggedIn:e.shopLoggedIn,couponReloadSkipped:e.couponReloadSkipped,errored:e.errored,runTime:e.runTime,runTimeV2:p,totalCouponsTested:o.default.get(e,"coupons.length"),coupons:o.default.get(e,"coupons"),originalCoupons:e.originalCoupons,preappliedCodes:e.preappliedCodes,bestCoupon:o.default.get(e,"bestCoupon.code"),platform:e.platform,cartData:l,actionLog:e.actionLog,currentLocation:o.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])})}Ze();export{Xe as a,D as b};
