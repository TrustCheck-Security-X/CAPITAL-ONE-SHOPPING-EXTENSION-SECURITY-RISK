import{l as le}from"./chunk-GXARYUH5.js";import{c as v,d as T,g as W,h as U}from"./chunk-7VR4VJF6.js";import{b as ve}from"./chunk-2LNQ42WD.js";import{a as _e}from"./chunk-NCANGEQT.js";import{i as ee,k as De}from"./chunk-B7TRBNR3.js";import{a as ne}from"./chunk-MYY6QNB4.js";import{d as M}from"./chunk-X2IWIW6K.js";import{c as te,d as oe,e as re}from"./chunk-JFLVCXPX.js";import{a as ye}from"./chunk-IUMQMMIE.js";import{a as Ce}from"./chunk-M25S27FE.js";import{b as Ve}from"./chunk-XEYZDI33.js";import{a as ge,b as he,c as X}from"./chunk-FMNBUMJ5.js";import{a as Q,b as B,e as Z}from"./chunk-QLZPWOED.js";import{b as G,d as R,n as ke}from"./chunk-4MWWZMVF.js";import{c as ze,h as u,i as j,k as pe,n as I,o as z,v as h}from"./chunk-2WJMAHXV.js";import{a as ue,d as $e}from"./chunk-W7K6NY26.js";import{G as J,z as ie}from"./chunk-4MSTBY6L.js";import{e as Y}from"./chunk-C4QCPH6A.js";import{d as de,f as Ke}from"./chunk-ZRHTGYWI.js";import{e as C}from"./chunk-3GYLW4KZ.js";var q=C(Y());var Pe=e=>h("getPostCheckoutDeals",e);var Be=e=>h("getPostCheckoutFeedsForTypes",e);var Se=e=>h("getReferralsOfferData",e);var ce=e=>h("setPostCheckoutOfferSeen",e);async function Me(e,o){return await Pe({context:M(),contentProps:{type:e,fillWithFallback:I("ext_post_checkout_fallback_deals"),domain:o}})}async function Dt(e,o){return await Be({context:M(),contentProps:{types:e,fillWithFallback:I("ext_post_checkout_fallback_deals"),domain:o}})}function Ee(e,o,l){return l?o.reduce((m,n)=>{let D=e?.[m.tld??""]||0,d=e?.[n.tld??""]||0;return D<=d?m:n}):o[0]}async function we(e,o={},l={},m,n=!1,D="",d=!1,_=Date.now()){let s=await Me(l.type??"deals",D);d&&T("offersRequest",_,[`block_slug:${e}`]);let c=I("ext_post_checkout_cycle_offers_v2"),i=s.items.length>0?Ee(s.seenOffers,s.items,c):void 0;i&&n&&s.canShowRetargeting&&c&&ce({tld:i.tld}),d&&(i?.tld&&n?v("singleOfferShown",[`tld:${U(i.tld)}`,`isAmazon:${D==="amazon.com"}`]):s.items.forEach(t=>{v("offerShown",[`tld:${U(t.tld)}`])}));let E=[];if(s.canShowRetargeting)if(n&&i)for(;i&&i.mitDisabled&&i.index<s.items.length-1;)E.push(q.default.clone(i)),c?(ce({tld:i.tld}),q.default.set(s,["seenOffers",i.tld],Date.now()),i=Ee(s.seenOffers,s.items,c)):i=s.items.find(t=>t.index===i.index+1);else s.items=s.items.reduce((t,r)=>r.mitDisabled?(E.push(r),t):(t.length<4&&t.push(r),t),[]);E.forEach(t=>{z("track","mitExtOffImpInd",{reason:"mit",offerDomain:t.tld,offerType:"post_checkout"})});let p={};if(e==="post-checkout-multi-ad-offer"){let t=await Se({experience:"multiOfferPCM",campaign:"",variant:0,source:"desktop",description:"multiOfferPCM"});d&&T("referralsData",_,[`block_slug:${e}`]),p={multiAdVersion:1,hasReferral:!!t&&(t?.senderBonus??0)>0,senderBonus:m((t?.senderBonus||0)*100,{truncateIntegers:!0}),maxReferralValue:m((t?.maxReferralValue||0)*100,{truncateIntegers:!0}),referralLink:t?.code?`${R}/account-settings/invite-friends?referralCode=${t?.code}`:null}}let w=he(e),f=await X(w);d&&T("blockTemplate",_,[`block_slug:${e}`]);let b={rootEl:"div",logLevel:null},P=q.default.reduce(s.items,(t,r)=>{let g=q.default.get(r,["stats","cashback"],"0%").replace("up to ","");return g>t?g:t},"0%"),y={offers:s,deals:s.items,currentDeal:i,threshold:i?.stats?.rewardTiers?.[0]?.displaySpendCents??"",threshold_reward:i?.stats?.rewardTiers?.[0]?.reward?.displayValue??"",currentDealCashback:i?.stats?.cashback,dealRewardType:i?.stats?.rewardType??"percentage",notification_text:JSON.stringify({offerCount:s.items.length,highestRate:P}),canShowRetargeting:s.canShowRetargeting,offer_exclusions:le([i?.tld??""]),all_offer_exclusions:le(s.items.map(t=>t?.tld??"")??[]),...p,...o},K={threshold:y.threshold,threshold_reward:y.threshold_reward,currentDealCashback:y.currentDealCashback,dealRewardType:y.dealRewardType,offerCount:s.items.length,currentDeal:i,highestRate:P,df:He(s.df??[],l.type??"deals"),dnf:qe(s)??[]},a=await re();return{config:b,content:f,data:y,meta:K,...a}}var We=new Set(["items","products","deals","multi","newOffers","recommended","threshold","recommendedProducts"]);function Ue(e,o){return We.has(e)&&Array.isArray(o)}function qe(e){let o=[];for(let[l,m]of Object.entries(e))Ue(l,m)&&o.push(...m.map(n=>({tld:n.tld,index:n.index,type:n.type}))??[]);return o}function He(e,o){return e.filter(l=>l.type===o)}var x=C(ie()),S=C(Y()),xe=C(ze());var me=C(Ve());$e();var A=C(ie());function fe(e,o,l=!0){let m=(0,A.useRef)(),n=(0,A.useRef)(),D=()=>{n.current&&(window.clearTimeout(n.current),n.current=void 0)};return(0,A.useEffect)(()=>{m.current=e},[e]),(0,A.useEffect)(()=>{function d(){m.current?.()}if(l)return n.current=window.setTimeout(d,o),()=>window.clearTimeout(n.current)},[o,l]),{clearTimeout:D}}var F=e=>h("activateOfferInNewTab",e);function be(){return pe("ext_post_checkout_auto_dismiss_delay_",5)*1e3}var ae=C(J()),N="postCheckoutRetargeting";function Ye({startTime:e=Date.now(),eventName:o=N,onUnload:l,onRenderComplete:m,blocksParams:n,providedData:D={},blocksSlug:d,contentProps:_={},isSingleOffer:s}){let[c,i]=(0,x.useState)(n),[E,p]=(0,x.useState)(void 0),{formatCurrency:w}=(0,x.useContext)(ke);function f(a,t,r,g={}){ee(o,a,t,r,g)}let{clearTimeout:b}=fe(()=>{let a=u.get(["siteAPIData","tld"])||"";v("auto_dismiss",[`tld:${W(a)}`]),f("auto_dismiss","dismiss","secondary"),l?.(!1)},be(),I("ext_post_checkout_auto_dismiss")&&!!l),P=a=>{let t=S.default.get(c?.data,"deals");if(t&&t[a]){let r=t[a],g=(0,xe.v4)(),k=(u.get(["siteAPIData","tld"])||"")==="amazon.com",V=o;o===N&&(k?V="amazonPostCheckout":V=r.pcp?"postCheckoutClick_1":"postCheckoutClick_0");let O={redirect:!0,cashback:!!r.stats.cashback,meta:JSON.stringify({index:a,view:d,cashback:r.stats.cashback,triggerType:V,merchantName:r.merchantName,redirectId:g,dealsLength:t.length})};f("","cta","primary",O);let $="";r.hrefV3?$=ue(r.hrefV3,{subExperience:"post_checkout",redirectId:g,clickEvent:k?"postCheckoutClick_ama":`postCheckoutClick_${r.pcp?"ps":"nps"}`}):$=r.href.replace("__WBCLICKID__",g).replace("subExperience=best_on_web","subExperience=post_checkout"),o===N&&(v(s?"dealClick":"multiOfferDealClick",[`tld:${U(r.tld)}`,`isAmazon:${k}`]),T("dealClick",e)),F({link:$,resolvedDomain:r.tld||(0,me.getSiteDomainFromUrl)(r.href)})}l&&l(!1)},y=()=>{let a=S.default.get(c?.data,"deals");if(a){let t={redirect:!0,meta:JSON.stringify({dealsLength:a.length})};if(o===N){let r=(u.get(["siteAPIData","tld"])||"")==="amazon.com";v("allDealClick",[`isAmazon:${r}`])}f("See all Offers","cta","secondary",t),F({link:R,resolvedDomain:G})}l&&l(!1)},K=a=>{if(a.type===B.Custom&&b(),te(a,l),a.type===B.RenderComplete&&a.data&&m?.(a.data.isEmpty),a.type===B.NotificationDismiss){let t=u.get(["siteAPIData","tld"]);t&&o===N&&v("dismiss",[`tld:${W(t)}`]),f("x","dismiss","primary")}if(a.type===B.Custom&&a.data){let t=a.data.propsData;if(t?.view==="non_product_retargeting"&&t?.link){let r=t.link;F({link:r,resolvedDomain:(0,me.getSiteDomainFromUrl)(r)}),l&&l(!1)}else if(a.eventName==="dealClick"&&S.default.isNumber(t?.index))P(t.index);else if(a.eventName==="allDealsClickToApp"||a.eventName==="allDealsClick")y();else if(a.eventName==="singleOfferClick"){let r=S.default.get(c?.data,["currentDeal","index"])||0;P(r)}else if(a.eventName==="referralClick"){let r=S.default.get(c,["data","referralLink"]);r&&window.open(r,"_blank","noopener noreferrer"),l&&l(!1)}}};return(0,x.useEffect)(()=>{n&&!S.default.isEqual(n,c)&&i(n)},[n,c]),(0,x.useEffect)(()=>{async function a(){let t=u.get("siteAPIData"),r=t?.tld,g=o===N;try{let k=[`block_slug:${d}`];g&&T("buildingNotif",e,k);let V=[`tld:${W(r)}`],O=await we(d,D,_,w,s,r,g,e);i(O);let $=S.default.get(O,["data","deals"]);if(!S.default.get(O,["data","canShowRetargeting"],!1)){v("cannotShowRetargeting",V),T("finish",e,k);return}if(!$?.length)g&&v("noOffersAvailable",[...k,`isAmazon:${r==="amazon.com"}`]),z("page",o,{view:"no_offers_available",meta:JSON.stringify({blocksSlug:d,contentProps:_})});else{let Ne=S.default.get(O,"meta",{}),Le=JSON.stringify({contentProps:_,...Ne});z("page",o,{view:d,meta:Le}),g&&v("offersAvailable",[...k,`isAmazon:${r==="amazon.com"}`])}g&&T("finish",e,k)}catch(k){k instanceof Error&&(g&&v("error",[`block_slug:${d}`,`tld:${W(r)}`]),p(k)),console.error(k)}}a()},[]),E?null:c?(0,ae.jsx)(Z,{client:Q.DESKTOP_WEB,config:c.config,content:c.content,host:c.host,user:c.user,data:c.data,onEvent:K,onRequest:oe}):(0,ae.jsx)("div",{className:"flex flex-1 align-center justify-center",children:(0,ae.jsx)(ne,{})})}var H=C(ie()),Ae=C(Y());var L=C(Y());Ke();var Oe=e=>h("getTopDeals",e);var Ie=e=>h("getXdIncentiveOffer",e);async function Je(){let[e,o,l,m]=await Promise.all([ye(),Ce(),De(),_e()]);e&&(u.set("pageViewId",window.__wb_page_view_id),u.set("session",L.default.get(e,"session")),u.set("events",L.default.get(e,"settings.events")),u.set("settings",L.default.get(e,"settings")),u.set("tabId",L.default.get(e,"tabId")),u.set("lexiFetchResponse",L.default.get(e,"lexiFetchResponse"))),u.merge({siteAPIData:o}),u.merge({cashback:l}),u.set("lifetimeSavings",m)}async function je(){try{return(await chrome.storage.local.get("lastCouponSavings"))?.lastCouponSavings??0}catch(e){return de("Error fetching lastCouponSavings, defaulting to 0",e),0}}async function Re(e,o,l={},m=!1,n=!1){let D=j("top_deals_post_checkout"),d=m&&(D||"post-checkout-deals-non-vm"===o),_=j("ext_incentive_eligibility")&&n,[s,c,i,E]=await Promise.all([await Je(),await je(),d?Oe({context:M(),loadPage:null}):Promise.resolve({}),_?Ie({sub_channel:"pre_cm"}):Promise.resolve(null)]),p=u.get("siteAPIData"),w=p?.siteData?.cashback?.reward||{},f=u.get("cashback"),b=ge(o),P=j("should_use_blocks_service")&&b?await X(b):void 0,y=P||await ve(e),K={rootEl:"div",logLevel:null},a={...i,$savings:{couponSavings:c??0,cashbackActivated:!!f?.user?.activated,couponsActivated:c>0},offer:E,topRewardsTypes:i,siteReward:w,couponSavings:c??0,...l},t=await re();return{config:K,content:y,data:a,...t}}var se=C(J());function Fe({contentSlug:e,onUnload:o,onRenderComplete:l,onPageView:m,blocksParams:n,isPreloadingBlocks:D=!1,providedData:d={},includeTopDeals:_=!1,blocksSlug:s,children:c}){function i(f,b,P,y={}){ee("postCheckoutRetargeting",f,b,P,y)}let E=f=>{te(f,o),f.type===B.NotificationDismiss&&s==="post-checkout-deals-non-vm"&&i("x","dismiss","primary"),f.type===B.RenderComplete&&f.data?l?.(f.data.isEmpty):f.type===B.Custom&&f.data?f.eventName==="exploreDeals"&&s==="post-checkout-deals-non-vm"&&(i("View Savings","cta","primary"),F({link:R,resolvedDomain:G}),o&&o()):f.type===B.PageView&&m?.(f)},[p,w]=(0,H.useState)(n);return(0,H.useEffect)(()=>{n&&!Ae.default.isEqual(n,p)&&w(n)},[n,p]),(0,H.useEffect)(()=>{!D&&!n&&Re(e,s,d,_).then(f=>w(f)).catch(console.error)},[]),p?(0,se.jsx)(Z,{client:Q.DESKTOP_WEB,config:p.config,content:p.content,host:p.host,user:p.user,data:p.data,onEvent:E,onRequest:oe,children:c}):(0,se.jsx)("div",{className:"flex flex-1 align-center justify-center",children:(0,se.jsx)(ne,{})})}export{Se as a,ce as b,Me as c,Dt as d,Ue as e,qe as f,Re as g,fe as h,Ye as i,Fe as j};
